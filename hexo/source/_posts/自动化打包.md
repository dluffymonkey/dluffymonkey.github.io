---
title: iOS 自动化打包脚本
date: 2018-03-19
tags: iOS
categories: iOS Tips
---
#### autobuild.py

iOS 自动化打包脚本，并上传*ipa*文件至蒲公英。参数说明:

```python
Usage: autobuild.py [options]

Options:
  -h, --help            show this help message and exit
  -w name.xcworkspace, --workspace=name.xcworkspace
                        Build the workspace name.xcworkspace.
  -p name.xcodeproj, --project=name.xcodeproj
                        Build the project name.xcodeproj.
  -s schemename, --scheme=schemename
                        Build the scheme specified by schemename. Required if
                        building a workspace.
  -m description, --desc=description
                        Pgyer update description.
  -a archivename.ipa, archivename=archivename
                        Pgyer upload if the archivename is not equal to the scheme
  -u isUpPgyer, --u=isUpPgyer
                        0 or 1, Whether or not upload to Pgyer
```

<!-- more -->

使用方式:

```python
#把py文件和ExportOptions.plist文件放在项目目录下才行
./autobuild.py -p youproject.xcodeproj -s schemename
或者
#把py文件和ExportOptions.plist文件放在项目目录下才行
./autobuild.py -w youproject.xcworkspace -s schemename
```

脚本中有几个全局变量，根据自己项目设置进行修改其值, 包括:

```python
CONFIGURATION = "Release"
EXPORT_OPTIONS_PLIST = "ExportOptions.plist"
#会在桌面创建输出ipa文件的目录
EXPORT_MAIN_DIRECTORY = "~/Desktop/"
```

*CONFIGURATION*：可在项目工程文件所在目录执行`xcodebuild -list`查看所有可选取值。
*EXPORT_OPTIONS_PLIST*：导出*ipa*文件时的配置参数，该参数值是你的配置参数文件名，请在*autobuild.py*文件所在目录下创建`ExportOptions.plist`文件，配置参数可使用`xcodebuild --help`查看所有可选取值。
*EXPORT_MAIN_DIRECTORY：默认情况下会在桌面创建*ipa*文件导出的文件夹，文件夹命名如:*~/Desktop/{scheme}{_2016-12-28_08-08-10}*。

```python
#configuration for pgyer
PGYER_UPLOAD_URL = "http://www.pgyer.com/apiv1/app/upload"
DOWNLOAD_BASE_URL = "http://www.pgyer.com"
USER_KEY = "af42xxxxxxxxxxxxxxxxxx"
API_KEY = "fd7fxxxxxxxxxxxxxxxxxx"
#设置从蒲公英下载应用时的密码
PYGER_PASSWORD = "" 
# 蒲公英更新描述
PGYDESC = ""
```

上传*ipa*文件至蒲公英的配置，你需要设置的是:*USER_KEY*, *API_KEY*, *PYGER_PASSWORD*。

代码如下：

```python
#!/usr/bin/env python
# -*- coding:utf-8 -*-

#./autobuild.py -p youproject.xcodeproj -s schemename     //把py文件和ExportOptions.plist文件放在项目目录下才行
#./autobuild.py -w youproject.xcworkspace -s schemename   //把py文件和ExportOptions.plist文件放在项目目录下才行
#python autobuild.py -p ../yourscheme.xcodeproj -s yourscheme
#python autobuild.py -w ../yourworkspace.xcworkspace -s yourscheme

import argparse
import subprocess
import requests
import os

#configuration for iOS build setting
CONFIGURATION = "Release"
EXPORT_OPTIONS_PLIST = "ExportOptions.plist"
#会在桌面创建输出ipa文件的目录
EXPORT_MAIN_DIRECTORY = "~/Desktop/"

# configuration for pgyer
PGYER_UPLOAD_URL = "https://www.pgyer.com/apiv1/app/upload"
DOWNLOAD_BASE_URL = "http://www.pgyer.com"
USER_KEY = "af42XXXXXXXXXXXXXXX"
API_KEY = "fd7fXXXXXXXXXXXXXXX"
#设置从蒲公英下载应用时的密码
PYGER_PASSWORD = "lq123"
# 蒲公英更新描述
PGYDESC = "This is LQ"

def cleanArchiveFile(archiveFile):
    cleanCmd = "rm -r %s" %(archiveFile)
    process = subprocess.Popen(cleanCmd, shell = True)
    process.wait()
    print "cleaned archiveFile: %s" %(archiveFile)


def parserUploadResult(jsonResult):
    resultCode = jsonResult['code']
    if resultCode == 0:
        downUrl = DOWNLOAD_BASE_URL +"/"+jsonResult['data']['appShortcutUrl']
        print "Upload Success"
        print "DownUrl is:" + downUrl
    else:
        print "Upload Fail!"
        print "Reason:"+jsonResult['message']

def uploadIpaToPgyer(ipaPath):
    print "ipaPath:"+ipaPath
    ipaPath = os.path.expanduser(ipaPath)
    ipaPath = unicode(ipaPath, "utf-8")
    files = {'file': open(ipaPath, 'rb')}
    headers = {'enctype':'multipart/form-data'}
    payload = {'uKey':USER_KEY,'_api_key':API_KEY,'installType':'2', 'password':PYGER_PASSWORD, 'updateDescription':PGYDESC}
    print "uploading...."
    r = requests.post(PGYER_UPLOAD_URL, data = payload ,files=files,headers=headers)
    if r.status_code == requests.codes.ok:
        result = r.json()
        parserUploadResult(result)
    else:
        print 'HTTPError,Code:'+r.status_code

#创建输出ipa文件路径: ~/Desktop/{scheme}{_2016-12-28_08-08-10}
def buildExportDirectory(scheme):
    dateCmd = 'date "+_%Y-%m-%d_%H-%M-%S"'
    process = subprocess.Popen(dateCmd, stdout=subprocess.PIPE, shell=True)
    (stdoutdata, stderrdata) = process.communicate()
    exportDirectory = "%s%s%s" %(EXPORT_MAIN_DIRECTORY, scheme, stdoutdata.strip())
    return exportDirectory

def buildArchivePath(tempName):
    process = subprocess.Popen("pwd", stdout=subprocess.PIPE)
    (stdoutdata, stderrdata) = process.communicate()
    archiveName = "%s.xcarchive" %(tempName)
    archivePath = stdoutdata.strip() + '/' + archiveName
    return archivePath

def getIpaPath(exportPath, scheme):
    cmd = "ls %s" %(exportPath)
    process = subprocess.Popen(cmd, stdout=subprocess.PIPE, shell=True)
    (stdoutdata, stderrdata) = process.communicate()
    #    ipaName = stdoutdata.strip()
    ipaPath = exportPath + "/" + scheme + ".ipa"
    return ipaPath

def exportArchive(scheme, archivePath):
    exportDirectory = buildExportDirectory(scheme)
    exportCmd = "xcodebuild -exportArchive -archivePath %s -exportPath %s -exportOptionsPlist %s" %(archivePath, exportDirectory, EXPORT_OPTIONS_PLIST)
    process = subprocess.Popen(exportCmd, shell=True)
    (stdoutdata, stderrdata) = process.communicate()
    
    signReturnCode = process.returncode
    if signReturnCode != 0:
        print "export %s failed" %(scheme)
        return ""
    else:
        return exportDirectory

def buildProject(project, scheme):
    archivePath = buildArchivePath(scheme)
    print "archivePath: " + archivePath
    archiveCmd = 'xcodebuild -project %s -scheme %s -configuration %s archive -archivePath %s -destination generic/platform=iOS' %(project, scheme, CONFIGURATION, archivePath)
    process = subprocess.Popen(archiveCmd, shell=True)
    process.wait()
    
    archiveReturnCode = process.returncode
    if archiveReturnCode != 0:
        print "archive workspace %s failed" %(workspace)
        cleanArchiveFile(archivePath)
    else:
        exportDirectory = exportArchive(scheme, archivePath)
        cleanArchiveFile(archivePath)
        if exportDirectory != "":
            ipaPath = getIpaPath(exportDirectory, scheme)
            uploadIpaToPgyer(ipaPath)

def buildWorkspace(workspace, scheme, archivename, upload):
    archivePath = buildArchivePath(scheme)
    print "archivePath: " + archivePath
    archiveCmd = 'xcodebuild -workspace %s -scheme %s -configuration %s archive -archivePath %s -destination generic/platform=iOS' %(workspace, scheme, CONFIGURATION, archivePath)
    process = subprocess.Popen(archiveCmd, shell=True)
    process.wait()
    
    archiveReturnCode = process.returncode
    if archiveReturnCode != 0:
        print "archive workspace %s failed" %(workspace)
        cleanArchiveFile(archivePath)
    else:
        exportDirectory = exportArchive(scheme, archivePath)
        cleanArchiveFile(archivePath)
        if exportDirectory != "":
            # ipaPath = getIpaPath(exportDirectory, scheme)
            if upload == 1:
                ipaPath = getIpaPath(exportDirectory, archivename)
                uploadIpaToPgyer(ipaPath)

def xcbuild(options):
    project = options.project
    workspace = options.workspace
    scheme = options.scheme
    desc = options.desc
    archivename = options.archivename
    upload = options.isUpPgyer
    
    global PGYDESC
    PGYDESC = desc
    
    if project is None and workspace is None:
        pass
    elif project is not None:
        buildProject(project, scheme)
    elif workspace is not None:
        buildWorkspace(workspace, scheme, archivename, upload)

def main():
    
    parser = argparse.ArgumentParser()
    parser.add_argument("-w", "--workspace", help="Build the workspace name.xcworkspace.", metavar="name.xcworkspace")
    parser.add_argument("-p", "--project", help="Build the project name.xcodeproj.", metavar="name.xcodeproj")
    parser.add_argument("-s", "--scheme", help="Build the scheme specified by schemename. Required if building a workspace.", metavar="schemename")
    parser.add_argument("-m", "--desc", help="Pgyer update description.", metavar="description")
    parser.add_argument("-a", "--archivename", help="Pgyer upload if the archivename is not equal to the scheme")
    parser.add_argument("-u", "--isUpPgyer", help="0 or 1, Whether or not upload to Pgyer")
    options = parser.parse_args()
    
    print "options: %s" % (options)
    
    xcbuild(options)

if __name__ == '__main__':
    main()

```
单独上传蒲公英的代码，直接在终端运行：

```
curl \
-F "file=@/Users/leo.yqjr/Desktop/MFFinancial 2018-01-09 16-47-58/MFFinancial.ipa" \
-F "uKey=af42XXXXXXXXXXXXXXX \
-F "_api_key=fd7fXXXXXXXXXXXXXXX" \
-F "installType=2" \
-F "password=lq123" \
-F "updateDescription=app1.0(3)测试版" \
https://www.pgyer.com/apiv1/app/upload
```
